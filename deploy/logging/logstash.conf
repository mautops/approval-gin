# Logstash 配置文件示例（用于处理日志并发送到 Elasticsearch）
input {
  beats {
    port => 5044
  }
  
  # 或者直接从文件读取
  # file {
  #   path => "/var/log/approval-gin/*.log"
  #   codec => json
  #   start_position => "beginning"
  # }
}

filter {
  # 解析 JSON 日志
  if [fields][service] == "approval-gin" {
    # 解析时间戳
    date {
      match => [ "time", "ISO8601" ]
      target => "@timestamp"
    }
    
    # 提取日志级别
    if [level] {
      mutate {
        add_field => { "log_level" => "%{level}" }
      }
    }
    
    # 提取请求信息
    if [request_id] {
      mutate {
        add_field => { "request_id" => "%{request_id}" }
      }
    }
    
    # 提取用户信息
    if [user_id] {
      mutate {
        add_field => { "user_id" => "%{user_id}" }
      }
    }
    
    # 提取操作信息
    if [action] {
      mutate {
        add_field => { "action" => "%{action}" }
      }
    }
    
    # 提取资源信息
    if [resource] {
      mutate {
        add_field => { "resource_type" => "%{resource}" }
      }
    }
    
    # 解析错误信息
    if [level] == "error" {
      mutate {
        add_tag => [ "error" ]
      }
    }
    
    # 解析警告信息
    if [level] == "warning" {
      mutate {
        add_tag => [ "warning" ]
      }
    }
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "approval-gin-%{+YYYY.MM.dd}"
    template_name => "approval-gin"
    template => "/etc/logstash/templates/approval-gin.json"
    template_overwrite => true
  }
  
  # 调试输出（可选）
  # stdout {
  #   codec => rubydebug
  # }
}

