---
alwaysApply: true
---

# Approval Gin Constitution

## 核心原则

### I. 基于 Approval Kit 构建

本项目必须基于 `approval-kit` 审批流核心库构建,不得重新实现审批流核心逻辑.所有审批状态管理、节点执行、状态转换等核心功能必须通过 `approval-kit` 提供的接口实现.本项目的职责是提供数据持久化、用户认证授权、REST API 接口等上层服务,而非实现审批流核心逻辑.

### II. 数据持久化职责

本项目负责所有数据的持久化存储,包括审批模板、审批任务、审批记录、状态变更历史等.必须选择合适的数据库技术(如 PostgreSQL、MySQL 等),设计合理的数据模型,确保数据一致性和完整性.所有数据操作必须支持事务,确保数据一致性.禁止在 `approval-kit` 中实现任何持久化逻辑.

### III. 权限管理集成

本项目必须使用 OpenFGA 进行权限管理,实现细粒度的权限控制.所有 API 接口必须进行权限检查,确保用户只能访问和操作有权限的资源.权限模型设计必须清晰,支持基于角色的访问控制(RBAC)和基于属性的访问控制(ABAC).权限检查必须在业务逻辑执行之前进行,禁止绕过权限检查.

### IV. REST API 设计规范

所有 API 接口必须遵循 RESTful 设计原则,使用标准的 HTTP 方法(GET、POST、PUT、DELETE、PATCH)和状态码.API 路径设计必须清晰、语义化,使用名词表示资源,使用动词表示操作.所有 API 必须提供统一的响应格式,包含状态码、消息、数据等字段.API 版本控制必须通过 URL 路径或请求头实现,确保向后兼容.

### V. 测试优先 (不可协商)

采用测试驱动开发(TDD): 先编写测试 → 用户批准 → 测试失败 → 然后实现.严格遵循红-绿-重构循环.所有核心功能必须包含单元测试,API 接口必须包含集成测试.测试覆盖率必须达到关键路径 100%,整体覆盖率不低于 80%.API 测试必须覆盖正常流程、异常流程、边界条件、权限验证等场景.

### VI. 简洁设计

遵循 YAGNI(You Aren't Gonna Need It)原则,避免过度设计.代码必须简洁明了,优先使用 Go 语言的标准库和惯用法.复杂的设计必须经过充分论证,说明为什么需要复杂性以及为什么更简单的方案不可行.保持接口最小化,避免暴露不必要的实现细节.API 设计应该直观易懂,减少学习成本.

### VII. API 稳定性与向后兼容

API 接口的变更必须谨慎,遵循语义化版本控制.主版本号内的 API 必须保持向后兼容,禁止在未升级主版本号的情况下移除或破坏性修改 API 接口.新增功能优先通过扩展接口实现,而非修改现有接口.所有 API 必须明确标注稳定性级别(稳定/实验性/已废弃).废弃的 API 必须提供至少一个主版本号的过渡期,并给出明确的迁移路径.

### VIII. 错误处理规范

所有可能失败的操作必须返回明确的错误信息.错误应该可分类、可处理,使用 Go 的 `error` 接口或自定义错误类型实现错误分类.禁止静默忽略错误,禁止使用 panic 处理业务逻辑错误.错误信息应该包含足够的上下文信息,便于问题排查和日志记录.API 错误响应必须包含错误码、错误消息、错误详情等字段,便于前端处理和用户提示.

### IX. 依赖管理

项目应该合理选择外部依赖,优先使用成熟稳定的库.引入第三方依赖必须经过充分论证,说明为什么需要该依赖以及为什么标准库无法满足需求.禁止引入仅用于单一功能的重量级依赖.所有依赖必须明确版本,并在 go.mod 中锁定.定期审查依赖,移除不再需要的依赖.优先选择维护活跃、社区认可度高的依赖库.

### X. 安全性要求

所有 API 接口必须进行身份认证和权限验证,禁止未授权访问.敏感数据必须加密存储,禁止明文存储密码、密钥等敏感信息.所有用户输入必须进行验证和清理,防止 SQL 注入、XSS 等安全漏洞.API 接口必须实现限流和防刷机制,防止恶意攻击.所有安全相关的配置必须通过环境变量或配置文件管理,禁止硬编码.

### XI. 文档完整性

所有公共 API 接口必须包含完整的文档注释,遵循 OpenAPI/Swagger 规范.提供 API 文档,包含接口说明、请求参数、响应格式、错误码等.提供使用示例代码,展示常见使用场景和最佳实践.README 必须包含快速开始指南、API 概览、部署说明和常见问题解答.所有示例代码必须可运行,并包含在文档或示例目录中.

### XII. 性能考虑

API 接口响应时间应该满足业务需求,关键接口响应时间应该控制在合理范围内.数据库查询必须优化,避免 N+1 查询问题,合理使用索引.对于高并发场景,必须考虑缓存策略,减少数据库压力.接口设计应该支持批量操作,减少网络开销.性能优化必须基于实际测量数据,避免过早优化.

## 技术约束

### 语言与版本

- **语言**: Go 1.25.4 或更高版本
- **Web 框架**: Gin (github.com/gin-gonic/gin)
- **权限管理**: OpenFGA
- **依赖管理**: 使用 Go modules
- **代码风格**: 遵循 Go 官方代码规范和 `gofmt` 格式化
- **代码检查**: 必须通过 `go vet` 和 `golangci-lint` 检查

### 架构约束

- **分层架构**: 采用分层架构设计,清晰分离控制器层、服务层、数据访问层
- **依赖注入**: 通过依赖注入实现组件解耦,便于测试和扩展
- **接口抽象**: 通过接口定义组件间的交互契约,支持实现替换
- **并发安全**: 所有公开接口必须保证并发安全,明确文档化并发使用场景
- **事务管理**: 所有数据操作必须支持事务,确保数据一致性

### 数据库约束

- **数据模型**: 数据模型设计必须清晰,支持审批模板、审批任务、审批记录等核心实体
- **版本控制**: 审批模板必须支持版本控制,确保历史任务可追溯
- **索引优化**: 必须为常用查询字段创建索引,优化查询性能
- **数据迁移**: 必须提供数据库迁移脚本,支持版本升级

### API 设计约束

- **RESTful 规范**: 所有 API 必须遵循 RESTful 设计原则
- **统一响应格式**: 所有 API 响应必须使用统一的格式
- **版本控制**: API 必须支持版本控制,通过 URL 路径或请求头实现
- **错误处理**: 所有错误必须返回标准的错误响应格式
- **文档规范**: 所有 API 必须提供 OpenAPI/Swagger 文档

### 权限管理约束

- **OpenFGA 集成**: 必须使用 OpenFGA 进行权限管理
- **权限模型**: 权限模型设计必须清晰,支持 RBAC 和 ABAC
- **权限检查**: 所有 API 接口必须进行权限检查
- **权限缓存**: 合理使用权限缓存,提高性能

## 开发流程

### 代码审查

- 所有 PR 必须验证是否符合本 constitution 的所有原则
- 复杂设计必须提供 Complexity Tracking 表格说明
- 测试覆盖率不达标不得合并
- API 变更必须提供向后兼容性说明
- 新增依赖必须说明引入理由
- 权限检查缺失不得合并

### 版本管理

- 遵循语义化版本控制 (Semantic Versioning)
- **MAJOR**: 破坏性 API 变更或数据库结构变更
- **MINOR**: 新增功能,向后兼容
- **PATCH**: bug 修复,向后兼容
- 每个版本必须包含 CHANGELOG,说明变更内容

### 质量门禁

- 所有代码必须通过 `go vet` 和 `golangci-lint` 检查
- 测试必须全部通过,关键路径测试覆盖率必须 100%
- 所有公共 API 必须有文档注释和 OpenAPI 文档
- 性能关键路径必须有基准测试
- 所有 API 必须有集成测试
- 数据库迁移脚本必须经过验证

### 发布流程

- 发布前必须更新版本号和 CHANGELOG
- 必须运行完整的测试套件和基准测试
- 必须验证所有 API 文档完整性
- 必须检查数据库迁移脚本
- 必须验证权限模型配置
- 重大版本发布前必须提供迁移指南

## 与 Approval Kit 的集成规范

### 接口实现

- 必须实现 `approval-kit` 提供的所有接口,包括 `TemplateManager`、`TaskManager` 等
- 实现必须基于数据库持久化,而非内存实现
- 所有状态转换必须通过 `approval-kit` 的状态机进行
- 禁止绕过 `approval-kit` 直接修改状态

### 数据同步

- 审批模板和审批任务的数据必须与 `approval-kit` 的数据结构保持一致
- 数据持久化时必须保存完整的模板和任务数据
- 从数据库加载数据时必须正确还原为 `approval-kit` 的数据结构

### 事件处理

- 必须实现 `approval-kit` 的事件处理器接口
- 事件推送必须异步处理,不阻塞主流程
- 事件推送失败必须有重试机制和错误处理

## 与前端 Approval Web 的协作规范

### API 设计

- API 设计必须考虑前端需求,提供便于前端使用的接口
- 响应数据格式必须便于前端渲染和处理
- 必须支持前端所需的查询、过滤、分页等功能

### 数据格式

- 所有日期时间必须使用 ISO 8601 格式
- 所有 JSON 数据必须遵循统一的命名规范
- 必须支持前端所需的数据结构转换

### 错误提示

- 错误消息必须清晰易懂,便于前端展示给用户
- 必须提供错误码,便于前端进行错误处理
- 权限错误必须返回明确的错误信息

## Governance

本 constitution 优先于所有其他开发实践和约定.任何对本 constitution 的修改必须:

1. 提供明确的修改理由和影响分析
2. 更新版本号和修改日期
3. 同步更新所有相关文档
4. 通知所有项目参与者

所有 PR 和代码审查必须验证是否符合本 constitution.任何违反原则的代码必须提供 Complexity Tracking 表格说明为什么需要违反,否则不得合并.

新增原则或重大原则修改需要:

- 至少一名核心维护者的批准
- 在项目 issue 或讨论区公开讨论
- 更新相关文档和示例

**Version**: 1.0.0 | **Ratified**: 2025-11-21 | **Last Amended**: 2025-11-21
