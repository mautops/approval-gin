---
alwaysApply: false
---

# Approval Gin 功能需求

## 项目定位

开发一个基于 `approval-kit` 审批流核心库的 REST API 服务,提供审批模板和审批任务的完整 API 接口.本项目负责数据持久化、用户认证授权、权限管理等上层服务,通过调用 `approval-kit` 实现审批流核心逻辑,不重新实现审批流状态管理功能.

## 核心功能需求

### 1. 数据持久化

系统必须实现所有审批数据的持久化存储,包括审批模板、审批任务、审批记录、状态变更历史等.必须选择合适的数据库技术(如 PostgreSQL、MySQL 等),设计合理的数据模型.

系统必须支持以下数据持久化功能:

- **模板持久化**: 支持模板的创建、更新、删除、查询操作,支持模板版本控制
- **任务持久化**: 支持任务的创建、更新、查询操作,保存任务完整状态和运行时数据
- **记录持久化**: 支持审批记录的持久化存储,便于查询和统计分析
- **历史持久化**: 支持状态变更历史的持久化存储,确保可追溯性
- **事务支持**: 所有数据操作必须支持事务,确保数据一致性
- **数据迁移**: 必须提供数据库迁移脚本,支持版本升级

### 2. REST API 接口

系统必须提供完整的 REST API 接口,遵循 RESTful 设计原则.所有 API 必须提供统一的响应格式,包含状态码、消息、数据等字段.

#### 2.1 模板管理 API

系统必须提供以下模板管理 API:

- `POST /api/v1/templates`: 创建审批模板
- `GET /api/v1/templates/{id}`: 获取模板详情(支持版本查询)
- `PUT /api/v1/templates/{id}`: 更新模板(创建新版本)
- `DELETE /api/v1/templates/{id}`: 删除模板
- `GET /api/v1/templates`: 查询模板列表(支持分页、过滤、排序)
- `GET /api/v1/templates/{id}/versions`: 获取模板版本列表

#### 2.2 任务管理 API

系统必须提供以下任务管理 API:

- `POST /api/v1/tasks`: 创建审批任务
- `GET /api/v1/tasks/{id}`: 获取任务详情
- `GET /api/v1/tasks`: 查询任务列表(支持多条件查询、分页、过滤、排序)
- `POST /api/v1/tasks/{id}/submit`: 提交任务
- `POST /api/v1/tasks/{id}/approve`: 审批同意
- `POST /api/v1/tasks/{id}/reject`: 审批拒绝
- `POST /api/v1/tasks/{id}/cancel`: 取消任务
- `POST /api/v1/tasks/{id}/withdraw`: 撤回任务
- `POST /api/v1/tasks/{id}/transfer`: 转交审批
- `POST /api/v1/tasks/{id}/add-approver`: 加签
- `POST /api/v1/tasks/{id}/remove-approver`: 减签
- `POST /api/v1/tasks/{id}/pause`: 暂停任务
- `POST /api/v1/tasks/{id}/resume`: 恢复任务
- `POST /api/v1/tasks/{id}/rollback`: 回退到指定节点
- `POST /api/v1/tasks/{id}/replace-approver`: 替换审批人

#### 2.3 查询 API

系统必须提供以下查询 API:

- `GET /api/v1/tasks?state={state}`: 按状态查询任务
- `GET /api/v1/tasks?template_id={template_id}`: 按模板查询任务
- `GET /api/v1/tasks?business_id={business_id}`: 按业务 ID 查询任务
- `GET /api/v1/tasks?approver={approver}`: 按审批人查询待审批任务
- `GET /api/v1/tasks?created_at_start={start}&created_at_end={end}`: 按时间范围查询任务
- `GET /api/v1/tasks/{id}/records`: 获取任务审批记录
- `GET /api/v1/tasks/{id}/history`: 获取任务状态变更历史

#### 2.4 API 设计规范

所有 API 必须遵循以下规范:

- **统一响应格式**: 所有 API 响应必须使用统一的格式 `{code, message, data}`
- **错误处理**: 所有错误必须返回标准的错误响应格式,包含错误码、错误消息、错误详情
- **版本控制**: API 必须支持版本控制,通过 URL 路径实现(如 `/api/v1/`)
- **分页支持**: 列表查询 API 必须支持分页,使用 `page` 和 `page_size` 参数
- **过滤排序**: 列表查询 API 必须支持过滤和排序功能
- **文档规范**: 所有 API 必须提供 OpenAPI/Swagger 文档

### 3. 用户认证和授权

系统必须实现完整的用户认证和授权机制,确保 API 安全访问.

#### 3.1 用户认证

系统必须支持以下认证方式:

- **JWT Token 认证**: 支持基于 JWT 的用户认证
- **Token 刷新**: 支持 Token 刷新机制
- **会话管理**: 支持用户会话管理

#### 3.2 OpenFGA 权限管理

系统必须使用 OpenFGA 进行细粒度的权限控制,实现以下权限管理功能:

- **权限模型定义**: 定义清晰的权限模型,支持 RBAC 和 ABAC
- **资源权限**: 支持模板、任务等资源的权限控制
- **操作权限**: 支持创建、读取、更新、删除等操作权限
- **权限检查**: 所有 API 接口必须在业务逻辑执行前进行权限检查
- **权限缓存**: 合理使用权限缓存,提高性能

系统必须支持以下权限场景:

- 用户只能查看和操作有权限的模板
- 用户只能查看和操作有权限的任务
- 审批人只能审批分配给自己的任务
- 任务创建者可以查看自己创建的任务
- 管理员拥有所有权限

### 4. 与 Approval Kit 的集成

系统必须正确集成 `approval-kit` 核心库,实现以下集成功能:

#### 4.1 接口实现

- **TemplateManager 实现**: 实现 `approval-kit` 的 `TemplateManager` 接口,基于数据库持久化
- **TaskManager 实现**: 实现 `approval-kit` 的 `TaskManager` 接口,基于数据库持久化
- **状态机集成**: 所有状态转换必须通过 `approval-kit` 的状态机进行
- **节点执行集成**: 所有节点执行必须通过 `approval-kit` 的节点执行器进行

#### 4.2 数据同步

- **数据结构一致性**: 数据库模型必须与 `approval-kit` 的数据结构保持一致
- **数据序列化**: 模板和任务数据必须正确序列化和反序列化
- **版本兼容**: 必须支持 `approval-kit` 的版本升级

#### 4.3 事件处理

- **事件处理器实现**: 实现 `approval-kit` 的事件处理器接口
- **事件持久化**: 支持事件持久化存储,便于查询和重试
- **事件推送**: 支持异步事件推送,不阻塞主流程
- **事件重试**: 支持事件推送失败重试机制

### 5. 数据查询和统计

系统必须提供强大的数据查询和统计功能:

- **多条件查询**: 支持按状态、模板、业务 ID、审批人、时间范围等多条件组合查询
- **分页查询**: 所有列表查询必须支持分页
- **排序功能**: 支持按创建时间、更新时间等字段排序
- **统计功能**: 支持任务统计、审批记录统计等功能
- **性能优化**: 必须为常用查询字段创建索引,优化查询性能

### 6. 系统管理

系统必须提供系统管理功能:

- **健康检查**: 提供健康检查接口 `GET /health`
- **配置管理**: 支持通过配置文件或环境变量管理系统配置
- **日志记录**: 记录所有关键操作日志,便于问题排查
- **监控指标**: 提供系统监控指标接口

## 非功能需求

### 性能要求

- API 响应时间: 关键接口响应时间应控制在 200ms 以内
- 并发支持: 必须支持高并发访问,支持至少 1000 QPS
- 数据库优化: 必须优化数据库查询,避免 N+1 查询问题
- 缓存策略: 对于高并发场景,必须考虑缓存策略

### 安全性要求

- **身份认证**: 所有 API 必须进行身份认证
- **权限验证**: 所有 API 必须进行权限验证
- **数据加密**: 敏感数据必须加密存储
- **输入验证**: 所有用户输入必须进行验证和清理
- **SQL 注入防护**: 必须防止 SQL 注入攻击
- **限流防刷**: 必须实现 API 限流和防刷机制

### 可靠性要求

- **数据一致性**: 必须确保数据一致性和完整性
- **事务支持**: 关键操作必须支持事务
- **错误处理**: 必须提供完善的错误处理机制
- **容错能力**: 必须支持从错误状态恢复
- **备份恢复**: 必须支持数据备份和恢复

### 可维护性要求

- **代码质量**: 必须确保代码质量和规范性
- **文档完整**: 必须提供完整的开发文档和 API 文档
- **测试覆盖**: 必须提供充分的测试用例,关键路径测试覆盖率 100%
- **日志记录**: 必须记录详细的操作日志

### 兼容性要求

- **API 兼容**: 必须保持 API 向后兼容
- **版本管理**: 必须支持 API 版本控制
- **升级迁移**: 必须支持平滑升级和数据迁移

## 技术约束

### 技术选型

- **语言**: Go 1.25.4 或更高版本
- **Web 框架**: Gin (github.com/gin-gonic/gin)
- **数据库**: PostgreSQL 或 MySQL
- **权限管理**: OpenFGA
- **ORM**: GORM 或类似 ORM 框架
- **认证**: JWT

### 架构约束

- **分层架构**: 必须采用分层架构,清晰分离控制器层、服务层、数据访问层
- **依赖注入**: 必须通过依赖注入实现组件解耦
- **接口抽象**: 必须通过接口定义组件间的交互契约
- **并发安全**: 所有公开接口必须保证并发安全
